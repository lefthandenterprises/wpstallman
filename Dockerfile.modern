# syntax=docker/dockerfile:1.6
FROM mcr.microsoft.com/dotnet/sdk:8.0-noble AS build

ENV DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1 \
    DOTNET_CLI_TELEMETRY_OPTOUT=1 \
    NUGET_PACKAGES=/root/.nuget/packages

WORKDIR /src

# Copy sln + project files only (maximize restore cache retention)
COPY WPStallman.sln ./
COPY src/WPStallman.Core/WPStallman.Core.csproj src/WPStallman.Core/
COPY src/WPStallman.GUI.Modern/WPStallman.GUI.csproj src/WPStallman.GUI.Modern/

# Restore with cache mounts
RUN --mount=type=cache,target=/root/.nuget/packages \
    --mount=type=cache,target=/src/src/WPStallman.Core/obj \
    --mount=type=cache,target=/src/src/WPStallman.GUI.Modern/obj \
    dotnet restore src/WPStallman.GUI.Modern/WPStallman.GUI.csproj -r linux-x64

# Now bring in the rest of the repo (source changes bust layers from here down)
COPY . .

# Publish with caches for obj/bin too
RUN --mount=type=cache,target=/root/.nuget/packages \
    --mount=type=cache,target=/src/src/WPStallman.Core/obj \
    --mount=type=cache,target=/src/src/WPStallman.GUI.Modern/obj \
    --mount=type=cache,target=/src/src/WPStallman.Core/bin \
    --mount=type=cache,target=/src/src/WPStallman.GUI.Modern/bin \
    dotnet publish src/WPStallman.GUI.Modern/WPStallman.GUI.csproj \
      -c Release -f net8.0 -r linux-x64 \
      -p:SelfContained=true -p:PublishSingleFile=false \
      -p:IncludeNativeLibrariesForSelfExtract=true \
      -o /out/publish-gtk41